<?php
session_start();


//トークンの発行
if($_SERVER['REQUEST_METHOD'] === "POST") {

if(!isset($_POST['token']) || $_POST['token'] !== getToken()){
	exit('処理を正常に完了できませんでした');
}

//各変数に値を入れる
$name = $_POST['name'];
$mail = $_POST['mail'];
$tel = $_POST['tel'];
$subject = $_POST['subject'];
$message = $_POST['message'];

$error = array();



//入力がない場合の処理

if (empty($message)){
	$error['message'] = 'メッセージは必ず入力してください';
}

if (empty($name)){
	$error['name'] = '名前は必ず入力してください';
}

if (empty($mail)){
	$error['mail'] = 'メールアドレスは必ず入力してください';
}

if (empty($tel)){
	$error['tel'] = '電話番号は必ず入力してください';
}

if (empty($subject)){
	$error['subject'] = '件名は必ず入力してください';
}




//バリデーションチェック

if(!filter_var($mail,FILTER_VALIDATE_EMAIL)) {
	$error['mail'] = 'メールアドレスの形式が正しくありません。';
}

//エラーがない場合の処理

if (empty($error)) {
	//メール送信処理

	$to = $mail;

	// 件名
	$subject = "お問い合わせ頂きありがとうございます | チームyurue";

	// 本文
	$message_mail = "
$name 様

チーム yurueです。
この度はお問い合わせ頂きありがとうございました。

お問い合わせ頂きました内容は以下のとおりです。
-------------------------------------
お名前：$name
メールアドレス：$email
内容：
$message
-------------------------------------

チーム yurueより、後ほど返信いたしますので、
今しばらくお待ちいだきますよう、よろしくお願い致します。

━━━━━━━━━━━━━━
チーム yurue （ユルイー）
Mail： yurue.team@gmail.com
HP  ： yurue.xyz
━━━━━━━━━━━━━━";

	$headers = 'From: yurue' . "\r\n" .
	'Reply-To: yurue.team@gmail.com' . "\r\n" .
	'X-Mailer: PHP/' . phpversion();

	mb_language('Japanese');
	mb_internal_encoding('UTF-8');

  	mb_send_mail($to,$subject,$message_mail,$headers);

	//送信完了後、値をクリア
	$message ="";
	$email="";
	$name="";
	}
 }


//特殊文字の処理
function h($str) {
	return htmlspecialchars($str,ENT_QUOTES,'UTF-8' );
}

//セッショントークンの生成
function getToken() {
	return hash('sha256', session_id());
}


?>

<!DOCTYPE html>
<html lang=ja>
<head>
	<meta charset="utf-8">
	<title>元気が出るデイサービスセンター</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script>
    	$(function(){
    		$("#menubtn").click(function(){
    			$("#menu").slideToggle();
    		});
    	});
    </script>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset/cssreset-min.css" />
    <link rel="stylesheet" type="text/css" href="./css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="./css/contact.css" />
</head>
<body>
	<header>
		<div class="title">
			<div class="site">
				<h1><a href="./index.html"> 元気が出るデイサービスセンター</a></h1>
			</div>
		</div>
		<div class="box2">
			<button type="button" id="menubtn">
			<i class="fa fa-bars"></i><span>MENU</span>	
			</button>
			<nav class="menu" id="menu">
			<ul>
			<li><a href="">概要</a></li>
			<li><a href="">沿革</a></li>
			<li><a href="">お問い合わせ</a></li>
			</ul>
			</nav>	
		</div>
	</header>
	
	<section class="page-title">
		<h2>お問い合わせ</h2>
	</section>
	<form class="form" method="post" action="">
	<input type="hidden" name="token" value="<?php echo getToken(); ?>"/>
		<div class="fo-style">
			<span class="budge">必須</span>
			<p>お名前</p>
			<input class="fo-name" type="text" name="name" size="50" maxlength="20" placeholder="お名前" required="" />
		</div>
		
		<div class="fo-style">
			<span class="budge">必須</span>
			<p>メールアドレス</p>
			<input class="fo-mail" type="text" name="mail" size="50" maxlength="256" placeholder="メールアドレス"  required="" />
		</div>

		<div class="fo-style">
			<span class="budge">必須</span>
			<p>電話番号</p>
			<input class="fo-tel" type="text" name="tel" size="50" maxlength="11" placeholder="電話番号" required="" />
		</div>

		<div class="fo-style">
			<span class="budge">必須</span>
			<p>件名</p>
			<input class="fo-sub" type="text" name="subject" size="50" maxlength="120" placeholder="件名" required="" />
		</div>

		<div class="fo-style">
			<span class="budge">必須</span>
			<p>お問い合わせ内容</p>
			<textarea  class="fo-main" rows="5" cols="50" name="message" placeholder="ここに記入してください" required=""></textarea>
		</div>

		<div class="fo-button fo-style">
			<button class="button" type="submit">送信</button>
		</div>
	</form>

	<footer>
		<div class="footer">
			<p>Copyright &copy;元気がでるデイサービスセンター</p>
			<span><a href="tel:0197252940"><i class="fa fa-phone"></i>：0197-25-2940</span>
		</div>
	</footer>
</body>
</html>